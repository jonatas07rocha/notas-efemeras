<script>
document.addEventListener("DOMContentLoaded", () => {

    // ===== CONFIG SAFE FALLBACK =====
    const SAFE_CONFIG = {
        DICT: {
            intents: {
                ganhei: ["ganhei","recebi","entrou","entrada"],
                gastei: ["gastei","paguei","comprei","saida","saída"],
                guardei: ["guardei","reservei","investi","poupei"]
            },
            methods: {
                PIX: ["pix"],
                CARD: ["credito","crédito","debito","débito","cartao","cartão"],
                BOL: ["boleto"]
            },
            essentials: ["aluguel","luz","agua","água","mercado","supermercado","farmacia","farmácia"],
            stop: ["de","do","da","no","na","com","para","pra","o","a"]
        },
        CATEGORIES: [
            { id:"cat_sal", name:"Receita", color:"#16a34a" },
            { id:"cat_res", name:"Reserva", color:"#06b6d4" },
            { id:"cat_ess", name:"Essencial", color:"#0f172a" },
            { id:"cat_laz", name:"Lifestyle", color:"#9B1B30" }
        ]
    };

    const CONFIG_SAFE = (typeof CONFIG !== "undefined") ? CONFIG : SAFE_CONFIG;

    // ===== STATE =====
    let transactions = [];
    try {
        transactions = JSON.parse(localStorage.getItem('rico_ruby_master')) || [];
    } catch {
        transactions = [];
    }

    const normalize = (t) =>
        t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    // ===== PARSER =====
    function parseInput(raw) {
        if (!raw.trim()) return null;

        const normalized = normalize(raw);
        const wordsNormalized = normalized.split(/\s+/);
        const wordsOriginal = raw.split(/\s+/);

        const moneyMatch = raw.match(/\d+([.,]\d+)*[.,]\d+|\d+/);
        if (!moneyMatch) return toast("Valor não identificado");

        const amount = parseFloat(
            moneyMatch[0].replace(/\./g, '').replace(',', '.')
        );

        if (!amount || amount <= 0) return toast("Valor inválido");

        let intent = "gastei";
        wordsNormalized.forEach(w => {
            if (CONFIG_SAFE.DICT.intents.ganhei.includes(w)) intent = "ganhei";
            if (CONFIG_SAFE.DICT.intents.guardei.includes(w)) intent = "guardei";
        });

        let method = "CASH";
        for (const [key, aliases] of Object.entries(CONFIG_SAFE.DICT.methods)) {
            if (wordsNormalized.some(w => aliases.includes(w))) {
                method = key;
                break;
            }
        }

        const intentVerbs = Object.values(CONFIG_SAFE.DICT.intents).flat();

        const filtered = wordsOriginal.filter((w, i) => {
            const wn = wordsNormalized[i];
            if (intentVerbs.includes(wn)) return false;
            if (wn.match(/\d/)) return false;
            if (CONFIG_SAFE.DICT.stop.includes(wn)) return false;
            return true;
        });

        const desc = filtered.join(" ").trim() || "DIVERSO";

        const subType =
            intent === "gastei" &&
            filtered.some(w =>
                CONFIG_SAFE.DICT.essentials.includes(normalize(w))
            )
                ? "essential"
                : "lifestyle";

        const categoryId =
            intent === "ganhei"
                ? "cat_sal"
                : intent === "guardei"
                ? "cat_res"
                : subType === "essential"
                ? "cat_ess"
                : "cat_laz";

        return {
            id: `id-${Date.now()}`,
            ts: Date.now(),
            amount,
            intent,
            subType,
            method,
            categoryId,
            desc,
            rawText: raw
        };
    }

    // ===== UI =====
    function updateUI() {
        const now = new Date();
        const monthly = transactions.filter(t => {
            const d = new Date(t.ts);
            return (
                d.getMonth() === now.getMonth() &&
                d.getFullYear() === now.getFullYear()
            );
        });

        const sum = (intent, sub = null) =>
            monthly
                .filter(t => t.intent === intent && (!sub || t.subType === sub))
                .reduce((a, b) => a + b.amount, 0);

        const g = sum("ganhei");
        const s = sum("gastei");
        const r = sum("guardei");

        setText("balance-val", `R$ ${(g - s - r).toLocaleString("pt-BR",{minimumFractionDigits:2})}`);
        setText("sum-ganhei", `R$ ${g.toLocaleString("pt-BR")}`);
        setText("sum-gastei", `R$ ${s.toLocaleString("pt-BR")}`);
        setText("sum-guardei", `R$ ${r.toLocaleString("pt-BR")}`);

        renderList(monthly);
        localStorage.setItem("rico_ruby_master", JSON.stringify(transactions));
    }

    function renderList(list) {
        const container = document.getElementById("history-list");
        if (!container) return;

        container.innerHTML =
            list
                .map(t => {
                    const cat =
                        CONFIG_SAFE.CATEGORIES.find(c => c.id === t.categoryId) ||
                        CONFIG_SAFE.CATEGORIES[0];

                    return `
                    <div class="p-6 bg-white rounded-3xl border border-slate-100 flex justify-between">
                        <div>
                            <p class="text-xs font-black uppercase">${t.desc}</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase">${cat.name}</p>
                        </div>
                        <p class="text-sm font-black">R$ ${t.amount.toLocaleString("pt-BR")}</p>
                    </div>`;
                })
                .join("") ||
            `<p class="text-center py-16 text-slate-300 font-black uppercase">Vazio</p>`;
    }

    function setText(id, value) {
        const el = document.getElementById(id);
        if (el) el.innerText = value;
    }

    function toast(msg) {
        const t = document.getElementById("toast");
        const m = document.getElementById("toast-msg");
        if (!t || !m) return null;
        m.innerText = msg;
        t.classList.remove("opacity-0","-translate-y-32");
        t.classList.add("opacity-100","translate-y-0");
        setTimeout(() => {
            t.classList.remove("opacity-100","translate-y-0");
            t.classList.add("opacity-0","-translate-y-32");
        }, 3000);
        return null;
    }

    // ===== EVENTS =====
    const form = document.getElementById("tx-form");
    if (form) {
        form.addEventListener("submit", e => {
            e.preventDefault();
            const input = document.getElementById("tx-input");
            const item = parseInput(input.value);
            if (item) {
                transactions.push(item);
                input.value = "";
                toast("CONCLUÍDO");
                updateUI();
            }
        });
    }

    document.querySelectorAll(".nav-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".nav-btn")
                .forEach(b => b.classList.remove("active"));

            document.querySelectorAll(".tab-content")
                .forEach(c => c.classList.remove("active"));

            btn.classList.add("active");

            const tab = document.getElementById(`tab-${btn.dataset.tab}`);
            if (tab) tab.classList.add("active");
        });
    });

    const resetBtn = document.getElementById("reset-btn");
    if (resetBtn) {
        resetBtn.onclick = () => {
            if (confirm("Resetar dados?")) {
                transactions = [];
                updateUI();
            }
        };
    }

    updateUI();
});
</script>